/*
Deployment script for BazaZaLigu

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "BazaZaLigu"
:setvar DefaultFilePrefix "BazaZaLigu"
:setvar DefaultDataPath "C:\Program Files\Microsoft SQL Server\MSSQL14.SQLEXPRESS\MSSQL\DATA\"
:setvar DefaultLogPath "C:\Program Files\Microsoft SQL Server\MSSQL14.SQLEXPRESS\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Dropping [dbo].[igrac_vodi_fk]...';


GO
ALTER TABLE [dbo].[Igrac] DROP CONSTRAINT [igrac_vodi_fk];


GO
PRINT N'Dropping [dbo].[igrac_klub_fk]...';


GO
ALTER TABLE [dbo].[Igrac] DROP CONSTRAINT [igrac_klub_fk];


GO
PRINT N'Dropping [dbo].[ima_igrac_fk]...';


GO
ALTER TABLE [dbo].[Ima] DROP CONSTRAINT [ima_igrac_fk];


GO
PRINT N'Dropping [dbo].[klub_liga_fk]...';


GO
ALTER TABLE [dbo].[Klub] DROP CONSTRAINT [klub_liga_fk];


GO
PRINT N'Dropping [dbo].[navija_klub_fk]...';


GO
ALTER TABLE [dbo].[Navija] DROP CONSTRAINT [navija_klub_fk];


GO
PRINT N'Dropping [dbo].[poseduje_klub_fk]...';


GO
ALTER TABLE [dbo].[Poseduje] DROP CONSTRAINT [poseduje_klub_fk];


GO
PRINT N'Dropping [dbo].[pripada_klub_fk]...';


GO
ALTER TABLE [dbo].[Pripada] DROP CONSTRAINT [pripada_klub_fk];


GO
PRINT N'Dropping [dbo].[vodi_klub_fk]...';


GO
ALTER TABLE [dbo].[Vodi] DROP CONSTRAINT [vodi_klub_fk];


GO
PRINT N'Starting rebuilding table [dbo].[Igrac]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Igrac] (
    [id_igraca]          INT          NOT NULL,
    [ime_igraca]         VARCHAR (20) NULL,
    [prezime_igraca]     VARCHAR (30) NULL,
    [vodi_id_trenera]    INT          NULL,
    [vodi_naziv]         VARCHAR (30) NULL,
    [naziv_kluba]        VARCHAR (30) NULL,
    [odigranih_utakmica] INT          NULL,
    [postignutih_golova] INT          NULL,
    [godine_igraca]      INT          NULL,
    [prosek_golova]      FLOAT (53)   NULL,
    CONSTRAINT [tmp_ms_xx_constraint_igrac_pk1] PRIMARY KEY CLUSTERED ([id_igraca] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Igrac])
    BEGIN
        INSERT INTO [dbo].[tmp_ms_xx_Igrac] ([id_igraca], [ime_igraca], [prezime_igraca], [vodi_id_trenera], [vodi_naziv], [naziv_kluba], [odigranih_utakmica], [postignutih_golova], [prosek_golova])
        SELECT   [id_igraca],
                 [ime_igraca],
                 [prezime_igraca],
                 [vodi_id_trenera],
                 [vodi_naziv],
                 [naziv_kluba],
                 [odigranih_utakmica],
                 [postignutih_golova],
                 [prosek_golova]
        FROM     [dbo].[Igrac]
        ORDER BY [id_igraca] ASC;
    END

DROP TABLE [dbo].[Igrac];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Igrac]', N'Igrac';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_igrac_pk1]', N'igrac_pk', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Starting rebuilding table [dbo].[Klub]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_Klub] (
    [naziv]        VARCHAR (30) NOT NULL,
    [grad]         VARCHAR (30) NULL,
    [vrednost]     INT          NULL,
    [liga_id_lige] INT          NULL,
    CONSTRAINT [tmp_ms_xx_constraint_klub_pk1] PRIMARY KEY CLUSTERED ([naziv] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[Klub])
    BEGIN
        INSERT INTO [dbo].[tmp_ms_xx_Klub] ([naziv], [grad], [liga_id_lige])
        SELECT   [naziv],
                 [grad],
                 [liga_id_lige]
        FROM     [dbo].[Klub]
        ORDER BY [naziv] ASC;
    END

DROP TABLE [dbo].[Klub];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_Klub]', N'Klub';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_klub_pk1]', N'klub_pk', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Creating [dbo].[igrac_vodi_fk]...';


GO
ALTER TABLE [dbo].[Igrac] WITH NOCHECK
    ADD CONSTRAINT [igrac_vodi_fk] FOREIGN KEY ([vodi_id_trenera], [vodi_naziv]) REFERENCES [dbo].[Vodi] ([trener_id_trenera], [klub_naziv]);


GO
PRINT N'Creating [dbo].[igrac_klub_fk]...';


GO
ALTER TABLE [dbo].[Igrac] WITH NOCHECK
    ADD CONSTRAINT [igrac_klub_fk] FOREIGN KEY ([naziv_kluba]) REFERENCES [dbo].[Klub] ([naziv]);


GO
PRINT N'Creating [dbo].[ima_igrac_fk]...';


GO
ALTER TABLE [dbo].[Ima] WITH NOCHECK
    ADD CONSTRAINT [ima_igrac_fk] FOREIGN KEY ([igrac_id_igraca]) REFERENCES [dbo].[Igrac] ([id_igraca]);


GO
PRINT N'Creating [dbo].[klub_liga_fk]...';


GO
ALTER TABLE [dbo].[Klub] WITH NOCHECK
    ADD CONSTRAINT [klub_liga_fk] FOREIGN KEY ([liga_id_lige]) REFERENCES [dbo].[Liga] ([id_lige]);


GO
PRINT N'Creating [dbo].[navija_klub_fk]...';


GO
ALTER TABLE [dbo].[Navija] WITH NOCHECK
    ADD CONSTRAINT [navija_klub_fk] FOREIGN KEY ([klub_naziv]) REFERENCES [dbo].[Klub] ([naziv]);


GO
PRINT N'Creating [dbo].[poseduje_klub_fk]...';


GO
ALTER TABLE [dbo].[Poseduje] WITH NOCHECK
    ADD CONSTRAINT [poseduje_klub_fk] FOREIGN KEY ([klub_naziv]) REFERENCES [dbo].[Klub] ([naziv]);


GO
PRINT N'Creating [dbo].[pripada_klub_fk]...';


GO
ALTER TABLE [dbo].[Pripada] WITH NOCHECK
    ADD CONSTRAINT [pripada_klub_fk] FOREIGN KEY ([klub_naziv]) REFERENCES [dbo].[Klub] ([naziv]);


GO
PRINT N'Creating [dbo].[vodi_klub_fk]...';


GO
ALTER TABLE [dbo].[Vodi] WITH NOCHECK
    ADD CONSTRAINT [vodi_klub_fk] FOREIGN KEY ([klub_naziv]) REFERENCES [dbo].[Klub] ([naziv]);


GO
PRINT N'Creating [dbo].[MyTrigger]...';


GO
CREATE TRIGGER [MyTrigger]
	ON [dbo].[Klub]
	AFTER  INSERT
	
	AS	
	BEGIN
		DECLARE @ID_lige int
		SELECT @ID_lige = liga_id_lige  FROM inserted

		UPDATE Liga  
		SET broj_klubova = broj_klubova + 1 
		WHERE Liga.id_lige = @ID_lige
	END
GO
PRINT N'Creating [dbo].[DeleteTriger]...';


GO
CREATE TRIGGER [DeleteTriger]
	ON [dbo].[Klub]
	FOR  DELETE
	AS
	BEGIN
		DECLARE @ID_lige int
		SELECT @ID_lige = liga_id_lige  FROM deleted

		UPDATE Liga  
		SET broj_klubova = broj_klubova - 1 
		WHERE Liga.id_lige = @ID_lige
	END
GO
PRINT N'Creating [dbo].[UpdateTriger]...';


GO
CREATE TRIGGER [UpdateTriger]
	ON [dbo].[Klub]
	FOR  UPDATE
	AS
	BEGIN
		DECLARE @ID_Prethodne_lige int
		DECLARE @ID_Nove_lige int
		SELECT @ID_Prethodne_lige = liga_id_lige  FROM deleted
		SELECT @ID_Nove_lige = liga_id_lige FROM inserted

		UPDATE Liga  
		SET broj_klubova = broj_klubova - 1 
		WHERE Liga.id_lige = @ID_Prethodne_lige

		UPDATE Liga  
		SET broj_klubova = broj_klubova + 1 
		WHERE Liga.id_lige = @ID_Nove_lige
	END
GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[Igrac] WITH CHECK CHECK CONSTRAINT [igrac_vodi_fk];

ALTER TABLE [dbo].[Igrac] WITH CHECK CHECK CONSTRAINT [igrac_klub_fk];

ALTER TABLE [dbo].[Ima] WITH CHECK CHECK CONSTRAINT [ima_igrac_fk];

ALTER TABLE [dbo].[Klub] WITH CHECK CHECK CONSTRAINT [klub_liga_fk];

ALTER TABLE [dbo].[Navija] WITH CHECK CHECK CONSTRAINT [navija_klub_fk];

ALTER TABLE [dbo].[Poseduje] WITH CHECK CHECK CONSTRAINT [poseduje_klub_fk];

ALTER TABLE [dbo].[Pripada] WITH CHECK CHECK CONSTRAINT [pripada_klub_fk];

ALTER TABLE [dbo].[Vodi] WITH CHECK CHECK CONSTRAINT [vodi_klub_fk];


GO
PRINT N'Update complete.';


GO
